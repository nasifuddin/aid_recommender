<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poverty Aid Advisor</title>
    <!-- 1. Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      /* Custom styles */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div class="max-w-5xl mx-auto p-4 md:p-8">
      <!-- Header -->
      <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900">
          Poverty Graduation Aid Advisor
        </h1>
        <p class="text-lg text-slate-600 mt-2">
          Enter household data to receive an AI-powered recommendation.
        </p>
      </header>

      <!-- Main Form -->
      <form
        id="aid-form"
        class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200"
      >
        <h2 class="text-2xl font-semibold mb-6 text-slate-900">
          Household Data Entry
        </h2>

        <!-- Form Grid -->
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-5"
        >
          <!-- These fields must match the Flask app's required inputs -->
          <div class="field-group">
            <label
              for="Participant_ID"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Participant ID</label
            >
            <input
              type="text"
              id="Participant_ID"
              name="Participant_ID"
              value="P-1001"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Marrital_Status"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Marital Status</label
            >
            <select
              id="Marrital_Status"
              name="Marrital_Status"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option>Married</option>
              <option>Others(Widow/Unmarried)</option>
            </select>
          </div>
          <div class="field-group">
            <label
              for="Family_Size"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Family Size</label
            >
            <input
              type="number"
              id="Family_Size"
              name="Family_Size"
              value="4"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="has_under5"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Children Under 5</label
            >
            <input
              type="number"
              id="has_under5"
              name="has_under5"
              value="1"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="has_50_plus"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Adults Over 50</label
            >
            <input
              type="number"
              id="has_50_plus"
              name="has_50_plus"
              value="0"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="has_18_50_Family_member"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Working-Age Adults (18-50)</label
            >
            <input
              type="number"
              id="has_18_50_Family_member"
              name="has_18_50_Family_member"
              value="2"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Income_Monthly_per_head"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Monthly Income (per head)</label
            >
            <input
              type="number"
              id="Income_Monthly_per_head"
              name="Income_Monthly_per_head"
              value="1500"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Total_Income_Annualy"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Total Annual Income</label
            >
            <input
              type="number"
              id="Total_Income_Annualy"
              name="Total_Income_Annualy"
              value="72000"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Savings_Amt"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Savings Amount</label
            >
            <input
              type="number"
              id="Savings_Amt"
              name="Savings_Amt"
              value="0"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Loans_Outstanding"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Outstanding Loans</label
            >
            <input
              type="number"
              id="Loans_Outstanding"
              name="Loans_Outstanding"
              value="5000"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Productive_Asset_Value"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Productive Asset Value</label
            >
            <input
              type="number"
              id="Productive_Asset_Value"
              name="Productive_Asset_Value"
              value="0"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Chronic_Patient_Num"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Chronic Patients (Num)</label
            >
            <input
              type="number"
              id="Chronic_Patient_Num"
              name="Chronic_Patient_Num"
              value="2"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Disabled_Yes"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Disabled in Household (0 or 1)</label
            >
            <input
              type="number"
              id="Disabled_Yes"
              name="Disabled_Yes"
              value="1"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Loans_Running_Yes"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Has Running Loans (0 or 1)</label
            >
            <input
              type="number"
              id="Loans_Running_Yes"
              name="Loans_Running_Yes"
              value="1"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="Loans_Num"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Number of Loans</label
            >
            <input
              type="number"
              id="Loans_Num"
              name="Loans_Num"
              value="1"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="field-group">
            <label
              for="has_Savings"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Has Savings (0 or 1)</label
            >
            <input
              type="number"
              id="has_Savings"
              name="has_Savings"
              value="0"
              class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        <!-- Submit Button -->
        <div class="mt-8 text-center">
          <button
            type="submit"
            id="submit-button"
            class="w-full md:w-1/2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150"
          >
            Get Recommendation
          </button>
        </div>
      </form>

      <!-- Loading Spinner -->
      <div id="loader" class="text-center py-12" style="display: none">
        <svg
          class="animate-spin h-10 w-10 text-blue-600 mx-auto"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-slate-600 mt-2">Analyzing household data...</p>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="mt-8 p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg shadow"
        style="display: none"
      >
        <strong>Error:</strong> <span id="error-text"></span>
      </div>

      <!-- Results Display -->
      <div
        id="results-container"
        class="mt-10 bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200"
        style="display: none"
      >
        <h2 class="text-2xl font-semibold mb-2 text-slate-900">
          Recommendation Report
        </h2>
        <p class="text-slate-600 mb-6">
          For Participant:
          <span id="result-participant-id" class="font-medium"></span>
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Left Panel: Eligibility -->
          <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-700">
              Eligibility Score
            </h3>
            <p
              id="result-eligibility-score"
              class="text-6xl font-bold text-blue-600 my-3"
            ></p>
            <h4 class="font-semibold text-slate-800 mt-4">
              Top 3 Eligibility Drivers:
            </h4>
            <ul id="eligibility-drivers-list" class="list-none mt-2 space-y-1">
              <!-- Drivers will be injected here by JS -->
            </ul>
          </div>

          <!-- Right Panel: Recommendation -->
          <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 class="text-lg font-semibold text-slate-700">
              Recommended Aid Type
            </h3>
            <p
              id="result-recommended-aid"
              class="text-4xl font-bold text-blue-700 my-5"
            ></p>
            <h4 class="font-semibold text-slate-800 mt-4">
              Top 3 Recommendation Drivers:
            </h4>
            <ul
              id="recommendation-drivers-list"
              class="list-none mt-2 space-y-1"
            >
              <!-- Drivers will be injected here by JS -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. JavaScript for API call -->
    <script>
      // Get DOM Elements
      const form = document.getElementById("aid-form");
      const submitButton = document.getElementById("submit-button");
      const loader = document.getElementById("loader");
      const resultsContainer = document.getElementById("results-container");
      const errorContainer = document.getElementById("error-message");
      const errorText = document.getElementById("error-text");

      // Define the list of base features your form provides
      const baseFeatures = [
        "Participant_ID",
        "Marrital_Status",
        "Family_Size",
        "has_under5",
        "has_50_plus",
        "has_18_50_Family_member",
        "Income_Monthly_per_head",
        "Savings_Amt",
        "Total_Income_Annualy",
        "Loans_Outstanding",
        "Productive_Asset_Value",
        "Chronic_Patient_Num",
        "Disabled_Yes",
        "Loans_Running_Yes",
        "Loans_Num",
        "has_Savings",
      ];

      // Define which features are numeric
      const numericFeatures = [
        "Family_Size",
        "has_under5",
        "has_50_plus",
        "has_18_50_Family_member",
        "Income_Monthly_per_head",
        "Savings_Amt",
        "Total_Income_Annualy",
        "Loans_Outstanding",
        "Productive_Asset_Value",
        "Chronic_Patient_Num",
        "Disabled_Yes",
        "Loans_Running_Yes",
        "Loans_Num",
        "has_Savings",
      ];

      // Listen for form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // Stop form from reloading page

        // Show loader, hide old results/errors
        loader.style.display = "block";
        resultsContainer.style.display = "none";
        errorContainer.style.display = "none";
        submitButton.disabled = true;
        submitButton.innerText = "Analyzing...";

        // 1. Create the JSON payload from the form
        const formData = new FormData(form);
        const payload = {};

        for (const key of baseFeatures) {
          const value = formData.get(key);
          // Convert numeric fields to numbers, leave others as strings
          if (numericFeatures.includes(key)) {
            payload[key] = parseFloat(value) || 0;
          } else {
            payload[key] = value;
          }
        }

        try {
          // 2. Send data to Flask API
          const response = await fetch("/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            // Handle HTTP errors (e.g., 400, 500)
            const errorData = await response.json();
            throw new Error(
              errorData.error || `Server error: ${response.status}`
            );
          }

          // 3. Display results
          const data = await response.json();
          displayResults(data);
        } catch (error) {
          // Handle network errors or API errors
          console.error("Inference error:", error);
          displayError(error.message);
        } finally {
          // 4. Clean up
          loader.style.display = "none";
          submitButton.disabled = false;
          submitButton.innerText = "Get Recommendation";
        }
      });

      function displayResults(data) {
        // Populate the results card
        document.getElementById("result-participant-id").innerText =
          data.participant_id;

        // Eligibility
        const score = (data.aid_eligibility_probability * 100).toFixed(1);
        document.getElementById(
          "result-eligibility-score"
        ).innerText = `${score}%`;

        // Recommendation
        document.getElementById("result-recommended-aid").innerText =
          data.recommended_aid;

        // Drivers
        const eligibilityList = document.getElementById(
          "eligibility-drivers-list"
        );
        const recommendationList = document.getElementById(
          "recommendation-drivers-list"
        );

        eligibilityList.innerHTML = "";
        recommendationList.innerHTML = "";

        data.top_3_eligibility_drivers.forEach((driver) => {
          eligibilityList.appendChild(createDriverLi(driver));
        });

        data.top_3_recommendation_drivers.forEach((driver) => {
          recommendationList.appendChild(createDriverLi(driver));
        });

        // Show the container
        resultsContainer.style.display = "block";
      }

      function createDriverLi(driver) {
        const li = document.createElement("li");
        li.className = "flex justify-between text-sm";

        const featureSpan = document.createElement("span");
        featureSpan.className = "text-slate-700";
        featureSpan.innerText = driver.feature.replace(/_/g, " ") + ":"; // Prettify name

        const contributionSpan = document.createElement("span");
        contributionSpan.className =
          driver.contribution > 0
            ? "font-medium text-green-600"
            : "font-medium text-red-600";
        contributionSpan.innerText =
          driver.contribution > 0
            ? `+${driver.contribution}`
            : driver.contribution;

        li.appendChild(featureSpan);
        li.appendChild(contributionSpan);
        return li;
      }

      function displayError(message) {
        errorText.innerText = message;
        errorContainer.style.display = "block";
      }
    </script>
  </body>
</html>
